[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
<% if @containerd -%>
BindsTo=containerd.service
<% end %>
<% if @docker_socket.nil? %>
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
<% else %>
After=network-online.target <%= @docker_name %>.socket firewalld.service containerd.service
Wants=network-online.target
Requires=<%= @docker_name %>.socket
<% end %>

[Service]
Type=notify
<% if @config.http_proxy %>
Environment="HTTP_PROXY=<%= @config.http_proxy %>"
<% end %>
<% if @config.https_proxy %>
Environment="HTTPS_PROXY=<%= @config.https_proxy %>"
<% end %>
<% if @config.no_proxy %>
Environment="NO_PROXY=<%= @config.no_proxy %>"
<% end %>
<% if @config.tmpdir %>
Environment="TMPDIR=<%= @config.tmpdir %>"
<% end %>
<% @env_vars.each do |key, val| %>
Environment="<%= key %>=<%= val %>"
<% end unless @env_vars.nil? %>
<% if @config.ipv4_forward %>
ExecStartPre=/sbin/sysctl -w net.ipv4.ip_forward=1
<% end %>
<% if @config.ipv6_forward %>
ExecStartPre=/sbin/sysctl -w net.ipv6.conf.all.forwarding=1
<% end %>
# the default is not to use systemd for cgroups because the delegate issues still
# exists and systemd currently does not support the cgroup feature set required
# for containers run by docker
ExecStart=<%= @docker_daemon_cmd %>
ExecReload=/bin/kill -s HUP $MAINPID
<% if @config.mount_flags %>
MountFlags=<%= @config.mount_flags %>
<% end %>
TimeoutSec=0
RestartSec=2
Restart=always
<%= @systemd_args  %>

# Note that StartLimit* options were moved from "Service" to "Unit" in systemd 229.
# Both the old, and new location are accepted by systemd 229 and up, so using the old location
# to make them work for either version of systemd.
StartLimitBurst=3

# Note that StartLimitInterval was renamed to StartLimitIntervalSec in systemd 230.
# Both the old, and new name are accepted by systemd 230 and up, so using the old name to make
# this option work for either version of systemd.
StartLimitInterval=60s

# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity

# Comment TasksMax if your systemd version does not support it.
# Only systemd 226 and above support this option.
TasksMax=infinity

# set delegate yes so that systemd does not reset the cgroups of docker containers
Delegate=yes

# kill only the docker process, not all processes in the cgroup
KillMode=process

[Install]
WantedBy=multi-user.target
